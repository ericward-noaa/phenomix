<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting time varying phenology models with the phenomix package • phenomix</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Fitting time varying phenology models with the phenomix package">
<meta property="og:description" content="phenomix">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phenomix</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/a1_examples.html">Fitting time varying phenology models with the phenomix package</a>
    </li>
    <li>
      <a href="../articles/a2_covariates.html">Including covariates</a>
    </li>
    <li>
      <a href="../articles/a3_troubleshooting.html">Troubleshooting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ericward-noaa/phenomix/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting time varying phenology models with the phenomix package</h1>
            
            <h4 data-toc-skip class="date">2022-09-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ericward-noaa/phenomix/blob/HEAD/vignettes/a1_examples.Rmd" class="external-link"><code>vignettes/a1_examples.Rmd</code></a></small>
      <div class="hidden name"><code>a1_examples.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ericward-noaa.github.io/phenomix" class="external-link">phenomix</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kaskr/adcomp/wiki" class="external-link">TMB</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: package 'TMB' was built under R version 4.1.2</span>
<span class="co">#&gt; Warning in checkMatrixPackageVersion(): Package version inconsistency detected.</span>
<span class="co">#&gt; TMB was built with Matrix version 1.4.1</span>
<span class="co">#&gt; Current Matrix version is 1.4.0</span>
<span class="co">#&gt; Please re-install 'TMB' from source using install.packages('TMB', type = 'source') or ask CRAN for a binary version of 'TMB' matching CRAN's 'Matrix' package</span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>phenomix</code> R package is designed to be a robust and flexible tool for modeling phenological change. The name of the package is in reference to modeling run timing data for salmon, but more generally this framework can be applied to any kind of phenology data – timing of leaf-out or flowering in plants, breeding bird surveys, etc. Observations may be collected across multiple years, or for a single year, and may be discrete or continuous. For a given time step, these data may look like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">110</span>,<span class="fl">150</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">df</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">x</span>, mean <span class="op">=</span> <span class="fl">130</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10000</span>
<span class="va">df</span><span class="op">$</span><span class="va">obs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>, <span class="va">df</span><span class="op">$</span><span class="va">y</span>, <span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Day of year"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Observation"</span><span class="op">)</span></code></pre></div>
<p><img src="a1_examples_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<p>For demonstration purposes, we incuded an example dataset, based on run timing data for Pacific salmon.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">fishdist</span><span class="op">)</span>
<span class="co">#&gt; Rows: 1,005</span>
<span class="co">#&gt; Columns: 3</span>
<span class="co">#&gt; $ year   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1960, 1960, 1960, 1960, 1960, 1960, 1960, 1960, 1960, 1960, 196…</span>
<span class="co">#&gt; $ number <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 5, 5, 5, 3, 9, 4, 3, 3, 5, 3, 3, 7, 2, 9, 21, 11, 75, 368, 385,…</span>
<span class="co">#&gt; $ doy    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 95, 113, 120, 121, 122, 123, 124, 126, 127, 128, 130, 131, 132,…</span></code></pre></div>
<div class="section level3">
<h3 id="manipulating-data-for-estimation">Manipulating data for estimation<a class="anchor" aria-label="anchor" href="#manipulating-data-for-estimation"></a>
</h3>
<p>The main data processing function in the package is called <code>create_data</code>, which builds the data and model arguments to be used for fitting. Note the names of the variables in our dataset,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fishdist</span><span class="op">)</span>
<span class="co">#&gt; [1] "year"   "number" "doy"</span></code></pre></div>
<p>We’ll start with the default arguments for the function, before going into detail about what they all mean. The only argument that we’ve initially changed from the default is using <code>asymmetric_model = FALSE</code> to fit the symmetric model.</p>
<p>First, if we’re fitting a model with covariates affecting the mean and standard deviation of the phenological response, we need to create a data frame indexed by time step.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cov_dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>nyear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">fishdist</span><span class="op">$</span><span class="va">year</span><span class="op">)</span><span class="op">)</span>
<span class="co"># rescale year -- could also standardize with scale()</span>
<span class="va">cov_dat</span><span class="op">$</span><span class="va">nyear</span> <span class="op">=</span> <span class="va">cov_dat</span><span class="op">$</span><span class="va">nyear</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">cov_dat</span><span class="op">$</span><span class="va">nyear</span><span class="op">)</span> </code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">datalist</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_data.html">create_data</a></span><span class="op">(</span><span class="va">fishdist</span>, 
  min_number<span class="op">=</span><span class="fl">0</span>, 
  variable <span class="op">=</span> <span class="st">"number"</span>, 
  time<span class="op">=</span><span class="st">"year"</span>, 
  date <span class="op">=</span> <span class="st">"doy"</span>,
  asymmetric_model <span class="op">=</span> <span class="cn">FALSE</span>, 
  mu <span class="op">=</span> <span class="op">~</span> <span class="va">nyear</span>,
  sigma <span class="op">=</span> <span class="op">~</span> <span class="va">nyear</span>,
  covar_data <span class="op">=</span> <span class="va">cov_dat</span>,
  est_sigma_re <span class="op">=</span> <span class="cn">TRUE</span>,
  est_mu_re <span class="op">=</span> <span class="cn">TRUE</span>,
  tail_model <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></code></pre></div>
<p>The <code>min_number</code> argument represents an optional threshold below which data is ignored. The <code>variable</code> argument is a character identifying the name of the response variable in the data frame. Similarly, the <code>time</code> and <code>date</code> arguments specify the labels of the temporal (e.g. year) and seasonal variables (day of year).</p>
<p>The remaining arguments to the function concern model fitting. The <code>phenomix</code> package can fit asymmetric or symmetric models to the distribution data (whether the left side of the curve is the same shape as the right) and defaults to FALSE. The mean and standard deviations that control the distributions are allowed to vary over time (as fixed or random effects) but we can also covariates in the mean and standard deviations (via formulas). Mathematically the mean location for a model with random effects is <span class="math inline">\(u_y \sim Normal(u_0, u_{\sigma})\)</span>, where <span class="math inline">\(u_0\)</span> is the global mean and <span class="math inline">\(u_{\sigma}\)</span> is the standard deviation. Adding a trend in normal space, this becomes <span class="math inline">\(u_y \sim Normal(u_0 + b_u*y, u_{\sigma})\)</span>, where the parameter <span class="math inline">\(b_u\)</span> controlls the trend. To keep the variance parameters controlling the tails of the run timing distribution positive, we estimate those random effects in log-space. This is specified as <span class="math inline">\(\sigma_y = exp(\sigma_0 + b_{\sigma}*y + \delta_{y})\)</span>, and <span class="math inline">\(\delta_{y} \sim Normal(0, \sigma_{\sigma})\)</span>. Trends in both the mean and variance are estimated by default, and controlled with the <code>est_sigma_trend</code> and <code>est_mu_trend</code> arguments. As described with the equations above, The trends are log-linear for the standard deviation parameters, but in normal space for the mean parameters.</p>
<p>Finally, the tails of the response curves may be estimated via fitting a Gaussian (normal) distribution, Student-t distribution, or <a href="https://en.wikipedia.org/wiki/Generalized_normal_distribution" class="external-link">generalized normal distribution</a>. By default, the Gaussian tails are estimated, and this parameter is controlled with the <code>tail_model</code> argument (“gaussian”, “student_t”, “gnorm”).</p>
<p>Last, we can model the observed count data with a number of different distributions, and set this with the <code>family</code> argument. Currently supported distributions include the lognorma (default, “lognormal”), Poisson (“poisson”), Negative Binomial (“negbin”), Binomial (“binomial”), and Gaussian (“gaussian”). The lognormal, Poisson and Negative Binomial models include a log link; Gaussian model includes an identity link, and Binomial model includes a logit link.</p>
</div>
<div class="section level3">
<h3 id="fitting-the-model">Fitting the model<a class="anchor" aria-label="anchor" href="#fitting-the-model"></a>
</h3>
<p>Next, we’ll use the <code>fit</code> function to do maximum likelihood estimation in TMB. Additional arguments can be found in the help file, but the most important one is the list of data created above with <code>create_data</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">fitted</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span></code></pre></div>
<p>We don’t get any warnings out of the estimation, but let’s look at the sdreport in more detail. <code>fitted</code> is of the <code>phenomix</code> class and contains the following</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">)</span>
<span class="co">#&gt; [1] "obj"       "init_vals" "data_list" "pars"      "sdreport"</span></code></pre></div>
<p>The <code>init_values</code> are the initial parameter values where optimization was started from, and the <code>data_list</code> represents the raw data. The <code>pars</code> component contains information relative to convergence and iterations, including the convergence code (0 = successful convergence),</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted</span><span class="op">$</span><span class="va">pars</span><span class="op">$</span><span class="va">convergence</span>
<span class="co">#&gt; [1] 0</span></code></pre></div>
<p>This looks like things are converging. But sometimes relative convergence (code = 4) won’t throw warnings. We can also look at the variance estimates, which also are estimated (a good sign things are converged!). These are all included in the <code>sdreport</code> – the parameters and their standard errors are accessible with</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sdrep_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"par"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdreport</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>,
  <span class="st">"value"</span><span class="op">=</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdreport</span><span class="op">$</span><span class="va">value</span>, <span class="st">"sd"</span><span class="op">=</span><span class="va">fitted</span><span class="op">$</span><span class="va">sdreport</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sdrep_df</span><span class="op">)</span>
<span class="co">#&gt;     par    value        sd</span>
<span class="co">#&gt; 1 theta 8.399995 0.2234016</span>
<span class="co">#&gt; 2 theta 8.638915 0.2258454</span>
<span class="co">#&gt; 3 theta 8.467173 0.2068679</span>
<span class="co">#&gt; 4 theta 8.154405 0.1577986</span>
<span class="co">#&gt; 5 theta 8.111876 0.1897451</span>
<span class="co">#&gt; 6 theta 8.243943 0.2206906</span></code></pre></div>
<p>If for some reason, these need to be re-generated, the <code>obj</code> object can be fed into</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">TMB</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/TMB/man/sdreport.html" class="external-link">sdreport</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">obj</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting-results">Plotting results<a class="anchor" aria-label="anchor" href="#plotting-results"></a>
</h3>
<p>Using our fitted object, there are some basic plotting functions included for diagnostics. Let’s plot run timing over time, by year:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">g</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_diagnostics.html">plot_diagnostics</a></span><span class="op">(</span><span class="va">fitted</span>, type<span class="op">=</span><span class="st">"timing"</span>, logspace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "years"</span>
<span class="va">g</span></code></pre></div>
<div class="figure">
<img src="a1_examples_files/figure-html/unnamed-chunk-11-1.png" alt="Fitted symmetric model with tails from a  Gaussian distribution" width="768"><p class="caption">
Fitted symmetric model with tails from a Gaussian distribution
</p>
</div>
<p>The object returned by <code>plot_diagnostics</code> is just a ggplot object, so additional arguments or themes can be added with <code>+</code> statements. The plot can be shown in normal space by setting <code>logspace=FALSE</code>. These run timing plots are the default, but additonal scatterplots of observed vs predicted values can be shown by setting <code>type=scatter</code>.</p>
</div>
<div class="section level3">
<h3 id="additional-examples">Additional examples<a class="anchor" aria-label="anchor" href="#additional-examples"></a>
</h3>
<p>First, we can try to fit the same model, but using an asymmetric t-distribution.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>

<span class="va">datalist</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_data.html">create_data</a></span><span class="op">(</span><span class="va">fishdist</span>, 
  min_number<span class="op">=</span><span class="fl">0</span>, 
  variable <span class="op">=</span> <span class="st">"number"</span>, 
  time<span class="op">=</span><span class="st">"year"</span>, 
  date <span class="op">=</span> <span class="st">"doy"</span>,
  asymmetric_model <span class="op">=</span> <span class="cn">FALSE</span>, 
  mu <span class="op">=</span> <span class="op">~</span> <span class="va">nyear</span>,
  sigma <span class="op">=</span> <span class="op">~</span> <span class="va">nyear</span>,
  covar_data <span class="op">=</span> <span class="va">cov_dat</span>,
  est_sigma_re <span class="op">=</span> <span class="cn">TRUE</span>,
  est_mu_re <span class="op">=</span> <span class="cn">TRUE</span>,
  tail_model <span class="op">=</span> <span class="st">"student_t"</span><span class="op">)</span>

<span class="va">fitted_t</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">datalist</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_diagnostics.html">plot_diagnostics</a></span><span class="op">(</span><span class="va">fitted_t</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "years"</span></code></pre></div>
<div class="figure">
<img src="a1_examples_files/figure-html/unnamed-chunk-13-1.png" alt="Fitted asymmetric model with heavy tails from a t-distribution" width="768"><p class="caption">
Fitted asymmetric model with heavy tails from a t-distribution
</p>
</div>
<p>We can also compare the two models using AIC. Note we’re not comparing random effects structures (where we’d need REML), and that this is an approximation (because only fixed effects parameters are included). This comparison shows that maybe not surprisingly, the Student-t model is more parsimoinious than the Gaussian tailed model (aic_2 &lt; aic_1).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aic_1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/extractAIC.html" class="external-link">extractAIC</a></span><span class="op">(</span><span class="va">fitted</span><span class="op">)</span><span class="op">$</span><span class="va">AIC</span>
<span class="va">aic_1</span>
<span class="co">#&gt; [1] 3226.133</span>

<span class="va">aic_2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/extractAIC.html" class="external-link">extractAIC</a></span><span class="op">(</span><span class="va">fitted_t</span><span class="op">)</span><span class="op">$</span><span class="va">AIC</span>
<span class="va">aic_2</span>
<span class="co">#&gt; [1] 2448.533</span></code></pre></div>
<p>Second, we can we can try to fit the same model, but using a generalized normal distribution. This distribution has a plateau or ‘flat top’. For examples, see the <code>gnorm</code> package on CRAN <a href="https://cran.r-project.org/web/packages/gnorm/index.html" class="external-link">here</a> or <a href="https://en.wikipedia.org/wiki/Generalized_normal_distribution" class="external-link">Wikipedia page</a>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>

<span class="va">datalist</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_data.html">create_data</a></span><span class="op">(</span><span class="va">fishdist</span>, 
  min_number<span class="op">=</span><span class="fl">0</span>, 
  variable <span class="op">=</span> <span class="st">"number"</span>, 
  time<span class="op">=</span><span class="st">"year"</span>, 
  date <span class="op">=</span> <span class="st">"doy"</span>,
  asymmetric_model <span class="op">=</span> <span class="cn">FALSE</span>, 
  tail_model <span class="op">=</span> <span class="st">"gnorm"</span><span class="op">)</span>
<span class="va">fitted</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span><span class="va">datalist</span>, limits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="diagnosing-lack-of-convergence">Diagnosing lack of convergence<a class="anchor" aria-label="anchor" href="#diagnosing-lack-of-convergence"></a>
</h3>
<p>In addition to the warning message about the Hessian not being positive definite, the NaNs in the <code>sd</code> column are a sure sign that things aren’t converging.</p>
<p>Fixes to improve convergence may be to start from a different set of starting values (try passing <code>inits</code> into the <code>fit</code> function), or placing stricter bounds on convergence statistics. Or it may be that the model isn’t a good fit to the data. Specifically, the convergence criterion can be modified with the <code>control</code> argument – which is passed into <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code>. One parameter in this list that can be changed is <code>rel.tol</code>, e.g.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">...</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rel.tol <span class="op">=</span> <span class="fl">1.0e-12</span>, 
  eval.max<span class="op">=</span><span class="fl">4000</span>, iter.max<span class="op">=</span><span class="fl">4000</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Eric J. Ward.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
